---
title: Increased fecundity associates with earlier offspring dispersal and son-bias in cooperative breeding Seychelles warblers
author: "Kiran Gok Lune Lee"
date: "2021"
geometry: margin=2cm 
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
    fig_width: 12
    fig_height: 10
  pdf_document:
    toc: yes
    fig_width: 8
    fig_height: 6

---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)


```
## Load packages and data


```{r eval = TRUE, echo = TRUE}
library(ggplot2)
library(dplyr)
library(plyr)
library(tidyverse)
library(ggpubr)
library(lme4)
library(readxl)

setwd("~/Desktop/Seychelles Warblers/MSc_thesis_Kiran_Lee_2021")


# territory quality data
YearlyTQData <- read_excel("YearlyTQ.xlsx")
TQ <- read_excel("TQ.xlsx")
TQ<-rename(TQ, c("PeriodYear"="Year"))
TQ<-rename(TQ, c("TQcorrected"="TerritoryQuality"))
TQ<-subset(TQ,  !is.na(TerritoryQuality))
TQ$logTerritoryQuality<-log(TQ$TerritoryQuality)
TQ$GelmanTerritoryQuality<-(TQ$logTerritoryQuality)-(mean(TQ$logTerritoryQuality))/(2*sd(TQ$logTerritoryQuality))  # transform territory quality

# sex ratio data
FullestSexRatioData <- read_excel("FullestSexRatioData.xlsx")
Data <- subset(FullestSexRatioData, !is.na(Year))
Data <- subset(Data, !is.na(Sex))
Data <- subset(Data, !is.na(TerritoryQuality))
Data <- subset(Data, pParentage>0.5) #choose chicks who's parentage is known with higher than half probability
Data$MumID[Data$MumID == "-998"] <- NA
Data$GelmanTerritoryQuality<-(log(Data$TerritoryQuality)-(mean(log(Data$TerritoryQuality))))/(2*sd(log(Data$TerritoryQuality))) # transform territory quality
ggplot(data=Data, aes(x=GelmanTerritoryQuality))+
  geom_histogram() #histogram to see spread of gelman territory quality. looks good


# status of each bird in field season
BirdIDSexYear <- read_excel("BirdIDSexYear.xlsx")

#create dataframe with summary stats per territory and then add this to other dataframes
TerritoryIDGroupStat<-ddply(Data, .(TerritoryID),summarise,
                   MeanTQbetweenyears= mean(TerritoryQuality),
                   RangeTQbetweenyears=max(TerritoryQuality)-min(TerritoryQuality),
                   sdTQbetweenyears= sd(TerritoryQuality),
                   SexRatiobetweenyears= mean(Sex),
                   cvTQbetweenyears= sdTQbetweenyears/MeanTQbetweenyears)
#add cvTQbetweenyears column
Data<-merge(x = Data , y = TerritoryIDGroupStat[ , c("TerritoryID", "cvTQbetweenyears")], by = "TerritoryID", all.x=TRUE)

# subset data so each row is a breedgroup in a field season
TData<-ddply(Data, .(Year, BreedGroupID, TerritoryID, nHelpers, nAB, nABX, nAllAB,nHelpersABX, nAdults,cvTQbetweenyears,nOffspringBreedGroup, FieldPeriodID),summarise, #This subset is important to not pseudoreplicate females offspring sex ratios. It takes the mean sex ratio when clutch size is bigger than 1.
             SexRatio= mean(Sex),
             TerritoryQuality= mean(TerritoryQuality),
             GelmanTerritoryQuality=mean(GelmanTerritoryQuality),
             nFem= length(Sex[Sex=="0"]), # number females per Year and territory ID
             nMale= length(Sex[Sex=="1"]),# number of males per year and territory ID
             nMums=n_distinct(MumID, na.rm = FALSE)
             
) 
#create dataframe with summary stats for each year on territory quality
TQgroupstata<-ddply(TQ, .(Year),summarise,
        MeanTQ= mean(TerritoryQuality),
        RangeTQ=max(TerritoryQuality)-min(TerritoryQuality),
        sdTQ= sd(TerritoryQuality),
        cvTQ= sdTQ/MeanTQ)
#add column of how variable territory qualities are within a year
TData<-merge(x = TData , y = TQgroupstata[ , c("Year", "cvTQ")], by = "Year", all.x=TRUE)
#make breedgroupid a factor
TData$BreedGroupID<- as.factor(TData$BreedGroupID)
#add a column for subordinate non-helpers
TData$NonHelpers<-TData$nAdults - TData$nHelpersABX
#add in the dominant mum and dad id for each breed group
DominantMaleIDSexYear<-subset(BirdIDSexYear, Status=="BrM")
DominantMaleIDSexYear$MaleID<-DominantMaleIDSexYear$BirdID

DominantFemaleIDSexYear<-subset(BirdIDSexYear, Status=="BrF")
DominantFemaleIDSexYear$FemaleID<-DominantFemaleIDSexYear$BirdID

TData<-merge(x = TData, y = DominantMaleIDSexYear[ , c("BreedGroupID", "MaleID")], by = "BreedGroupID", all.x=TRUE)
TData<-merge(x = TData, y = DominantFemaleIDSexYear[ , c("BreedGroupID", "FemaleID")], by = "BreedGroupID", all.x=TRUE)
#add column of how variable a territory's quality is
TData<-merge(x = TData , y = TerritoryIDGroupStat[ , c("TerritoryID", "cvTQbetweenyears")], by = "TerritoryID", all.x=TRUE)
#add column of how variable territory qualities are within a year
TData<-merge(x = TData , y = TQgroupstata[ , c("Year", "cvTQ")], by = "Year", all.x=TRUE)
TData$BreedGroupID<- as.factor(TData$BreedGroupID)

#create dataframe with summary stats for each year on territory quality
TQgroupstata<-ddply(TQ, .(Year),summarise,
        MeanTQ= mean(TerritoryQuality),
        RangeTQ=max(TerritoryQuality)-min(TerritoryQuality),
        sdTQ= sd(TerritoryQuality),
        cvTQ= sdTQ/MeanTQ)

##create dataframe with summary stats for each year on numbers daughters and males and territory quality 
DataGroupStat<-ddply(Data, .(Year),summarise,
                   MeanTQ= mean(TerritoryQuality),
                   RangeTQ=max(TerritoryQuality)-min(TerritoryQuality),
                   sdTQ= sd(TerritoryQuality),
                   OffspringSexRatio= mean(Sex), # mean offspring sex ratio had in that year
                   cvTQ= sdTQ/MeanTQ,
                   nDaughters= length(Sex[Sex=="0"]), # number daughters had in that year
                   nSons= length(Sex[Sex=="1"])) # number sons had in that year




# add fieldperiod start and end dates into dataframes
#first create dataframe with summary stats per fieldperiod
FieldPeriodIDGroupStat<-ddply(BirdIDSexYear, .(FieldPeriodID, PeriodEnd, PeriodStart),summarise,
                              nFem= length(Sex[Sex=="0"]),
                              nMale= length(Sex[Sex=="1"]))
FieldPeriodIDGroupStat$PeriodLength<-FieldPeriodIDGroupStat$PeriodEnd-FieldPeriodIDGroupStat$PeriodStart

Data<-merge(x = Data , y = FieldPeriodIDGroupStat [ , c("FieldPeriodID", "PeriodStart")], by = "FieldPeriodID", all.x=TRUE)
Data<-merge(x = Data , y = FieldPeriodIDGroupStat [ , c("FieldPeriodID", "PeriodEnd")], by = "FieldPeriodID", all.x=TRUE)
Data<-merge(x = Data , y = FieldPeriodIDGroupStat [ , c("FieldPeriodID", "PeriodLength")], by = "FieldPeriodID", all.x=TRUE)
TData<-merge(x = TData , y = FieldPeriodIDGroupStat [ , c("FieldPeriodID", "PeriodLength")], by = "FieldPeriodID", all.x=TRUE)

# create sex ratio data including mum's status
PedigreePlusStatus<- read_excel("PedigreePlusStatus.xlsx")
MumStatus <- subset(PedigreePlusStatus, !is.na(Year))
MumStatus <- subset(MumStatus, !is.na(Sex))
MumStatus <- subset(MumStatus, !is.na(TerritoryQuality))
MumStatus <- subset(MumStatus, pParentage>0.5) #choose chicks who's parentage is known with higher than half probability
MumStatus$MumID <- as.character(MumStatus$MumID)
MumStatus$MumID[MumStatus$MumID == "-998"] <- "NA"
MumStatus$MumID<- as.factor(MumStatus$MumID)
MumStatus$TerritoryQuality<-as.numeric(gsub(",", ".", MumStatus$TerritoryQuality))
MumStatus$GelmanTerritoryQuality<-(log(MumStatus$TerritoryQuality)-(mean(log(MumStatus$TerritoryQuality))))/(2*sd(log(MumStatus$TerritoryQuality)))
#add cvTQbetweenyears column
MumStatus<-merge(x = MumStatus , y = TerritoryIDGroupStat[ , c("TerritoryID", "cvTQbetweenyears")], by = "TerritoryID", all.x=TRUE)
Mumstatusgroupstat<-ddply(MumStatus, .(MumID,BreedGroupID,TerritoryID,GelmanTerritoryQuality,FieldPeriodID,nHelpers, nAB, nABX, nAllAB, nHelpersABX, nAdults,Year,cvTQbetweenyears,Status),summarise,
                    OffspringSexRatio= mean(Sex),
                    nFem= length(Sex[Sex=="0"]), # number females per treatment group
                    nMale= length(Sex[Sex=="1"]))

Mumstatusgroupstat$ClutchSize<-Mumstatusgroupstat$nFem+Mumstatusgroupstat$nMale
Mumstatusgroupstat<-merge(x = Mumstatusgroupstat , y = FieldPeriodIDGroupStat [ , c("FieldPeriodID", "PeriodLength")], by = "FieldPeriodID", all.x=TRUE)
# assign dominancy to mums
MumStatus$StatusBrF<-revalue(MumStatus$Status, c(ABX="NonBrF",H="NonBrF",AB="NonBrF",NSA="NonBrF",SEEN1="NonBrF",SEEN2="NonBrF",NS="NonBrF",OFL="NonBrF",SBR="NonBrF",TBRF="NonBrF"))
Mumstatusgroupstat$Dominant<-Mumstatusgroupstat$Status
Mumstatusgroupstat$Dominant[Mumstatusgroupstat$Status!="BrF"] <- 0
Mumstatusgroupstat$Dominant[Mumstatusgroupstat$Status=="BrF"] <- 1
Mumstatusgroupstat$NonHelpers<-Mumstatusgroupstat$nAdults - Mumstatusgroupstat$nHelpersABX
Mumstatusgroupstat$Dominant<-as.factor(Mumstatusgroupstat$Dominant)

#mum group stat. My dataset contains 995 mums and 1034 dads.
Mumgroupstat<-ddply(Data, .(MumID,BreedGroupID,GelmanTerritoryQuality,nHelpers, nAB, nABX, nAllAB,nHelpersABX, nAdults,Year,cvTQbetweenyears,PeriodLength),summarise,
                          OffspringSexRatio= mean(Sex),
                          nFem= length(Sex[Sex=="0"]), # number females per treatment group
                          nMale= length(Sex[Sex=="1"]))
Mumgroupstat$ClutchSize<-Mumgroupstat$nFem+Mumgroupstat$nMale



```
## Offspring that could be assigned genetic parentage with at least 50% confidence (mean +/- SE confidence of parentage = 0.98 +/- 0.002, n= 1140) were included
```{r eval = TRUE, echo = TRUE}
mean(Data$pParentage)
sd(Data$pParentage, na.rm=TRUE) /  
  sqrt(length(Data$pParentage[!is.na(Data$pParentage)]))
nrow(Data)
```
## three subsequent years as most offspring (this study: 92.1%, n=508) disperse by then
```{r eval = TRUE, echo = TRUE}

```
## Most mothers have singleton clutches per breeding season, though 14.7% (144/977) produce multiple offspring, up to four per breeding season (mean +/- SE= 1.17 +/- 0.014). 
```{r eval = TRUE, echo = TRUE}
table(Mumgroupstat$ClutchSize)
mean(Mumgroupstat$ClutchSize)
sd(Mumgroupstat$ClutchSize, na.rm=TRUE) /  
  sqrt(length(Mumgroupstat$ClutchSize[!is.na(Mumgroupstat$ClutchSize)]))
```
## 13.7% (128/931) of mothers are co-breeding subordinates NB: This statement in my report is incorrect if we run the script (126/932).
```{r eval = TRUE, echo = TRUE}
table(MumStatus$StatusBrF)
```
## the number of offspring produced by breed groups, with an upper limit of seven per breeding season (mean +/- SE= 1.68 +/- 0.031) 
NB: This statement in my report is incorrect if we run the script (1.35+/- 0.027). 
```{r eval = TRUE, echo = TRUE}
mean(TData$nOffspringBreedGroup)
sd(TData$nOffspringBreedGroup, na.rm=TRUE) /  
  sqrt(length(TData$nOffspringBreedGroup[!is.na(TData$nOffspringBreedGroup)]))
```

## Breed groups with more helping subordinates, but not non-helping subordinates produce more offspring (figure 1), with no impact of territory quality or field period length in which sampling took place (table 1)
```{r eval = TRUE, echo = TRUE}
#Territories with more helpers have larger clutches visually
table(TData$nHelpers)

ggplot(data=subset(TData), aes(x=factor(nHelpers), y=nOffspringBreedGroup))+
 geom_violin() +
  stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red")+
  geom_jitter(alpha = .25, width = .2, height = 0.1) +
  ylim(1,7)+ 
  labs(x= "number of helping subordinates", y="number of offspring born")+
  theme(axis.title.x = element_text(size = rel(2)),
        axis.title.y = element_text(size = rel(2)),
        axis.text =element_text(size = rel(1.5)))+
  annotate("text", size=5,y = 0.5, x = 1, label = "n=2")+
  annotate("text",size=5, y = 0.5, x = 2, label = "n=25")+
  annotate("text", size=5, y = 0.5, x = 3, label = "n=180")+
  annotate("text", size=5,y = 0.5, x =4, label = "n=656")+
  ylim(0.5,7)

mm<-glmer(nOffspringBreedGroup ~ GelmanTerritoryQuality +nHelpers + NonHelpers +PeriodLength + (1|TerritoryID) + (1|FieldPeriodID)+ (1|MaleID)+ (1|FemaleID), data=TData, family=poisson)
summary(mm)
drop1(mm, test="Chisq")
```
## Breed groups in better quality territories sustain more adult individuals (estimate= 0.179, SE= 0.080, p= 0.025, figure 2)
```{r eval = TRUE, echo = TRUE}
mmm<-glmer(nAdults~GelmanTerritoryQuality + (1|FieldPeriodID) + (1|TerritoryID) + (1|MaleID) + (1|FemaleID), data=TData, family=poisson)
summary(mmm)
drop1(mmm, test="Chisq")

ggplot(data=TData, aes(x=factor(nAdults) , y=GelmanTerritoryQuality))+
  geom_violin() + coord_flip() +
  stat_summary(fun.y=mean, mult=1, 
               geom="pointrange", color="red")+
  geom_jitter(alpha = .25, width = .2, height = 0.1)+
  labs(x= "number of subordinates", y="territory quality")+
  theme(axis.title.x = element_text(size = rel(2)),
        axis.title.y = element_text(size = rel(2)),
        axis.text =element_text(size = rel(1.5)))+
  annotate("text", size=5,y = -1.9, x = 7, label = "n=6")+
  annotate("text",size=5, y = -1.9, x = 6, label = "n=10")+
  annotate("text", size=5, y = -1.9, x = 5, label = "n=32")+
  annotate("text", size=5,y = -1.9, x =4, label = "n=83")+
  annotate("text",size=5, y = -1.9, x = 3, label = "n=203")+
  annotate("text", size=5, y = -1.9, x = 2, label = "n=295")+
  annotate("text", size=5, y = -1.9, x = 1, label = "n=234")+ ylim(-2.01,2.01)
```

## Per mother, the number of offspring produced is not influenced by territory quality (estimate= 0.039, SE= 0.068, p= 0.566), by the number of helping subordinates (estimate=  0.0610, SE= 0.068, p= 0.566),  or by non-helping subordinates in the breed group (estimate= 0.003, SE= 0.035, p= 0.938), whether she is dominant or subordinate (estimate= 0.032, SE= 0.102, p= 0.756), or the field period length in which sampling took place (estimate<0.001, SE= 0.002, p= 0.893)
```{r eval = TRUE, echo = TRUE}
mmm<-glmer(ClutchSize ~ GelmanTerritoryQuality+nHelpers+Dominant +  NonHelpers+ PeriodLength + (1|TerritoryID) + (1|MumID), data=subset(Mumstatusgroupstat), family=poisson)

summary(mmm)
```

## 53.2% (453/851) of offspring disperse after one year, 85.9% (556/647) after two years and 92.1% (468/508) after three years

```{r eval = TRUE, echo = TRUE}

```
## Rates of offspring dispersal from the natal territory increases when offspring natal territory quality is higher and when more offspring are born in the breed group (table 2, Fig. 2). 

```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```
## 


```{r eval = TRUE, echo = TRUE}

```